# 依赖关系说明

## 版本配置总览

### 核心依赖版本
| 依赖 | 版本 | 说明 |
|------|------|------|
| **Spring Boot** | 4.0.1 | 主框架版本 |
| **JDK** | 21 | Java 版本（Spring Boot 4.0 最低要求） |
| **MyBatis-Plus** | 3.5.15 | ORM 框架 |
| **PostgreSQL** | 42.7.9 | 数据库驱动 |
| **JJWT** | 0.12.6 | JWT 认证库 |
| **FreeMarker** | 2.3.32 | 模板引擎 |
| **MapStruct** | 1.6.3 | 对象映射 |
| **Hutool** | 5.8.29 | Java 工具库 |

## 模块依赖关系图

```
ez-admin-starter (启动模块)
  ↓ 依赖
ez-admin-application-system (应用层)
  ↓ 依赖
ez-admin-domain-system (领域层) + ez-admin-auth-api (认证接口) + ez-admin-framework (框架层)
  ↓ 依赖
ez-admin-common (基础层)

ez-admin-auth-core (认证中心)
  ↓ 依赖
ez-admin-auth-api (接口层) + ez-admin-framework (框架层) + ez-admin-domain-system (领域层)
```

## 详细依赖清单

### 1. ez-admin-common（基础层）
**依赖**：无
**说明**：全局通用模块，工具类、异常处理

---

### 2. ez-admin-framework（框架层）
**依赖**：
- ez-admin-common
- Spring Web
- Spring Security 7
- Spring Data Redis
- Spring Validation
- MyBatis-Plus
- PostgreSQL Driver
- JJWT（API + Impl + Jackson）

**说明**：提供 Security、Redis、JWT、MyBatis 通用能力

---

### 3. ez-admin-domain（领域层父模块）
**依赖**：无（父模块不引入依赖）
**说明**：领域层父模块，负责聚合子模块

---

### 4. ez-admin-domain-system（系统领域层）
**依赖**：
- ez-admin-framework
  - ez-admin-common
  - Spring Web
  - Spring Security 7
  - Spring Data Redis
  - Spring Validation
  - MyBatis-Plus
  - PostgreSQL Driver
  - JJWT

**说明**：实体、Mapper、原子服务（由代码生成器生成）

---

### 5. ez-admin-auth（认证中心父模块）
**依赖**：无（父模块不引入依赖）
**说明**：认证中心父模块，负责聚合子模块

---

### 6. ez-admin-auth-api（认证接口层）
**依赖**：
- spring-web（轻量级，仅提供注解支持）
- Spring Validation

**说明**：DTO、枚举、异常、服务接口（轻量级接口层）

---

### 7. ez-admin-auth-core（认证实现层）
**依赖**：
- ez-admin-auth-api
- ez-admin-framework（获取 Security、Redis、JWT）
- ez-admin-domain-system（获取 User、Role 实体）
- Spring Boot Test
- Spring Security Test

**说明**：认证核心实现

---

### 8. ez-admin-application（应用层父模块）
**依赖**：无

---

### 9. ez-admin-application-system（系统应用层）
**依赖**：
- ez-admin-domain-system（领域层实体、Mapper、原子服务）
- ez-admin-auth-api（认证授权接口）
- ez-admin-framework（Web、Security、Redis、MyBatis 通用能力）
- MapStruct（对象映射）

**说明**：Controller、聚合服务、DTO（手写业务逻辑）

---

### 10. ez-admin-generator（代码生成器）
**依赖**：
- MyBatis-Plus Generator
- MyBatis-Plus Spring Boot 4.x Starter
- PostgreSQL Driver
- FreeMarker

**说明**：代码生成工具

---

### 11. ez-admin-starter（启动模块）
**依赖**：
- ez-admin-application-system（应用层，间接依赖所有其他模块）

**传递依赖**：
- ez-admin-application-system → ez-admin-domain-system
- ez-admin-application-system → ez-admin-auth-api
- ez-admin-application-system → ez-admin-framework
- ez-admin-framework → ez-admin-common

**说明**：应用启动入口（仅需依赖应用层，其他依赖自动传递）

---

## 依赖管理策略

### 父 POM 统一管理
所有第三方依赖版本在 **根 pom.xml** 的 `<dependencyManagement>` 中统一管理：

```xml
<properties>
    <spring-boot.version>4.0.1</spring-boot.version>
    <mybatis-plus.version>3.5.15</mybatis-plus.version>
    <postgresql.version>42.7.9</postgresql.version>
    <jjwt.version>0.12.6</jjwt.version>
    <freemarker.version>2.3.32</freemarker.version>
    <mapstruct.version>1.6.3</mapstruct.version>
    <hutool.version>5.8.29</hutool.version>
</properties>

<dependencyManagement>
    <dependencies>
        <!-- 所有依赖版本在此定义 -->
    </dependencies>
</dependencyManagement>
```

### 子模块引用方式
子模块引用依赖时**无需指定版本**：

```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-spring-boot4-starter</artifactId>
    <!-- 版本由父 POM 管理 -->
</dependency>
```

---

## Spring Boot 4.0 特性

### 主要变化
1. **最低 JDK 21**：必须使用 JDK 21 或更高版本
2. **Jakarta EE 10**：包名从 `javax.*` 迁移到 `jakarta.*`
3. **原生支持 GraalVM**：更好的原生镜像支持
4. **性能提升**：启动速度和内存占用优化

### 本项目适配
- ✅ 使用 `spring-boot-starter-web`（替代 spring-boot-starter-webmvc）
- ✅ 使用 `mybatis-plus-spring-boot4-starter`（MyBatis-Plus 4.x）
- ✅ 使用 `jakarta.*` 包名（如 `jakarta.servlet.*`）
- ✅ 使用 JDK 21 编译

---

## 注意事项

### 1. 版本冲突
避免在同一模块中引入不同版本的同一依赖：

```xml
<!-- ❌ 错误：同时引入两个版本 -->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-spring-boot4-starter</artifactId>
    <version>3.5.15</version>
</dependency>
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-spring-boot4-starter</artifactId>
    <version>3.5.16</version>
</dependency>

<!-- ✅ 正确：由父 POM 管理版本 -->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-spring-boot4-starter</artifactId>
</dependency>
```

### 2. 循环依赖
确保模块依赖关系无循环：

```
✅ 正确：A → B → C
❌ 错误：A → B → C → A
```

### 3. 传递依赖
使用 `mvn dependency:tree` 查看完整的依赖树：

```bash
mvn dependency:tree
```

---

## 常用命令

### 查看依赖树
```bash
# 查看整个项目依赖树
mvn dependency:tree

# 查看某个模块的依赖树
mvn dependency:tree -pl ez-admin-framework

# 查看依赖分析
mvn dependency:analyze
```

### 清理并重新编译
```bash
# 清理并编译（跳过测试）
mvn clean compile -DskipTests

# 清理并打包（跳过测试）
mvn clean package -DskipTests
```

### 查看有效 POM
```bash
# 查看合并后的有效 POM
mvn help:effective-pom
```

---

## 更新日志

### 2026-01-19（第二轮优化）
- ✅ 修复 ez-admin-application-system 依赖（添加 auth-api、framework、mapstruct）
- ✅ 优化 ez-admin-auth-api 依赖（使用轻量级 spring-web 替代 spring-boot-starter-web）
- ✅ 重构 ez-admin-domain 依赖结构（移除父模块依赖，子模块按需声明）
- ✅ 更新依赖关系文档，确保与实际依赖一致
- ✅ 验证无循环依赖

### 2026-01-19（第一轮优化）
- ✅ 统一所有依赖版本到父 POM 管理
- ✅ 修复 `${projet.version}` 拼写错误为 `${project.version}`
- ✅ 移除所有子模块的硬编码版本号
- ✅ 添加 Spring Boot 4.0.1 支持
- ✅ 优化依赖结构，避免循环依赖

---

## 优化说明

### 优化1：应用层依赖补全
**问题**：`ez-admin-application-system` 缺少必要的认证和框架依赖
**解决**：显式声明 `ez-admin-auth-api`、`ez-admin-framework`、`mapstruct` 依赖
**效果**：应用层可以正常使用认证、Web、Security、对象转换等功能

### 优化2：认证接口层轻量化
**问题**：`ez-admin-auth-api` 使用了过重的 `spring-boot-starter-web` 依赖
**解决**：改用轻量级的 `spring-web`（仅提供注解支持，不包含 Web 容器）
**效果**：减少传递依赖，保持接口层轻量级特性

### 优化3：领域层依赖扁平化
**问题**：`ez-admin-domain` 父模块声明了依赖，导致所有子模块继承
**解决**：移除父模块依赖，由子模块按需声明
**效果**：依赖关系更清晰，符合分层架构原则

### 架构优势
- ✅ **单向依赖**：应用层 → 领域层 → 框架层 → 基础层
- ✅ **无循环依赖**：所有模块依赖关系为单向树状结构
- ✅ **职责清晰**：父模块只负责聚合，子模块按需引入依赖
- ✅ **传递优化**：接口层使用轻量级依赖，减少不必要的传递
