# 动态查询系统设计文档

## 一、设计理念

### 1.1 背景问题

传统后台管理系统的查询条件通常是这样的：

```java
// ❌ 传统方式：每个模块都要定义专属的查询 DTO
public class UserQueryReq {
    private String username;
    private String nickname;
    private String phoneNumber;
    private Integer status;
    private Long deptId;
    private String startTime;
    private String endTime;
    // ... 每次增加查询条件都要修改这个类
}

public class RoleQueryReq {
    private String roleName;
    private String roleKey;
    private Integer status;
    // ... 又是重复的代码
}
```

**问题**：
- 每个模块都要定义专属的查询类，代码重复
- 新增查询条件需要修改 DTO、Mapper、Service 层
- 前端需要为每个模块定制不同的查询表单
- 代码维护成本高，容易出错

### 1.2 解决方案

**统一的动态查询框架**：

```
PageQuery（通用，所有模块共用）
├── pageNum、pageSize    # 分页参数
├── orders              # 排序条件
├── keyword            # 快捷模糊搜索（如：用户名/昵称/手机号）
└── conditions         # 高级查询（前端控制任意字段组合）
```

**优势**：
- ✅ 所有模块共用同一个 `PageQuery`，无需为每个模块定义查询类
- ✅ 前端查询表单统一，减少开发成本
- ✅ 新增查询字段只需注册配置，无需修改代码逻辑
- ✅ 类型安全，防止 SQL 注入

---

## 二、架构设计

### 2.1 核心组件

```
┌─────────────────────────────────────────────────────────────┐
│                      前端请求                                │
│  POST /user/page                                            │
│  { pageNum: 1, pageSize: 10, keyword: "admin",              │
│    conditions: [{"field":"status","operator":"EQ","value":"1"}] } │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Controller Layer                                           │
│  @PostMapping("/page")                                      │
│  public R<PageVO<UserListVO>> page(@RequestBody PageQuery query) │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Service Layer                                              │
│  userService.getUserPage(query);                            │
│  └── userMapper.selectUserPage(query.toMpPage(), query);    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Mapper Layer                                               │
│  QueryConditionSupport.applyConditions(wrapper, conditions);│
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  MyBatis-Plus                                               │
│  LambdaQueryWrapper → SQL                                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 包结构

```
common/
├── condition/
│   ├── FieldConfig.java           # 字段配置（定义哪些字段可查询）
│   └── QueryConditionSupport.java  # 动态查询支持（核心逻辑）
├── enums/
│   ├── FieldType.java             # 字段类型（STRING/INTEGER/LONG）
│   └── Operator.java              # 操作符（EQ/LIKE/IN 等）
├── model/
│   ├── PageQuery.java             # 通用分页查询请求
│   └── PageVO.java                # 通用分页响应
dto/common/
└── QueryCondition.java            # 查询条件 DTO
```

---

## 三、核心组件详解

### 3.1 PageQuery（通用分页查询请求）

```java
@Data
public class PageQuery {
    private Integer pageNum = 1;           // 当前页码
    private Integer pageSize = 10;          // 每页条数
    private List<OrderItem> orders;         // 排序条件
    private String keyword;                 // 快捷搜索关键词
    private List<QueryCondition> conditions; // 高级查询条件列表
}
```

**设计要点**：
- `pageNum`、`pageSize`：符合前端习惯的分页命名
- `keyword`：快捷搜索，适用于大部分场景（如：用户名/昵称/手机号）
- `conditions`：高级查询，支持任意字段组合

### 3.2 QueryCondition（查询条件 DTO）

```java
@Data
public class QueryCondition {
    private String field;      // 字段名（驼峰命名，如 username）
    private String operator;   // 操作符（EQ/NE/LIKE/IN 等）
    private String value;      // 字段值
}
```

**前端请求示例**：
```json
{
  "field": "username",
  "operator": "LIKE",
  "value": "admin"
}
```

### 3.3 Operator（操作符枚举）

```java
public enum Operator {
    EQ("EQ", "等于"),
    NE("NE", "不等于"),
    GT("GT", "大于"),
    GE("GE", "大于等于"),
    LT("LT", "小于"),
    LE("LE", "小于等于"),
    LIKE("LIKE", "模糊匹配"),
    NOT_LIKE("NOT_LIKE", "不包含"),
    IN("IN", "包含于"),
    NOT_IN("NOT_IN", "不包含于");
}
```

**支持的查询类型**：

| 操作符 | 说明 | 适用字段类型 | 示例 |
|--------|------|--------------|------|
| EQ | 等于 | 全部 | `status = 1` |
| NE | 不等于 | 全部 | `status != 0` |
| GT/GE/LT/LE | 大于/大于等于/小于/小于等于 | 数值 | `deptId > 10` |
| LIKE | 模糊匹配 | 字符串 | `username LIKE '%admin%'` |
| NOT_LIKE | 不包含 | 字符串 | `username NOT LIKE '%test%'` |
| IN | 包含于 | 全部 | `status IN (1,2,3)` |
| NOT_IN | 不包含于 | 全部 | `status NOT IN (0,1)` |

### 3.4 FieldConfig（字段配置）

```java
public record FieldConfig<T>(
    String fieldCode,           // 字段代码（前端传入）
    SFunction<T, ?> column,     // Lambda 字段引用（类型安全）
    FieldType type              // 字段类型
) {
    public static <T> FieldConfig<T> string(String fieldCode, SFunction<T, String> column);
    public static <T> FieldConfig<T> integer(String fieldCode, SFunction<T, Integer> column);
    public static <T> FieldConfig<T> longNum(String fieldCode, SFunction<T, Long> column);
}
```

**作用**：定义哪些字段可以参与动态查询，防止 SQL 注入。

### 3.5 QueryConditionSupport（动态查询支持）

```java
public final class QueryConditionSupport {
    // 注册表：Key=实体类, Value=字段配置 Map
    private static final Map<Class<?>, Map<String, FieldConfig<?>>> REGISTRY = ...;

    // 注册字段配置
    public static <T> void register(Class<T> entityClass, FieldConfig<T>... configs);

    // 应用查询条件
    public static <T> void applyConditions(LambdaQueryWrapper<T> wrapper,
                                           List<QueryCondition> conditions,
                                           Class<T> entityClass);
}
```

**核心流程**：
1. 注册字段配置（Mapper 初始化时）
2. 解析查询条件（前端传入）
3. 匹配字段配置（防止 SQL 注入）
4. 应用 Lambda 查询（类型安全）

---

## 四、流程图

### 4.1 完整查询流程

```
┌────────────────────────────────────────────────────────────────┐
│ 1. 前端发起请求                                               │
│    POST /user/page                                            │
│    {                                                          │
│      "pageNum": 1,                                            │
│      "pageSize": 10,                                          │
│      "keyword": "admin",                                       │
│      "conditions": [                                          │
│        {"field": "username", "operator": "LIKE", "value": "admin"}, │
│        {"field": "status", "operator": "EQ", "value": "1"}          │
│      ]                                                        │
│    }                                                          │
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│ 2. Controller 接收请求                                         │
│    @PostMapping("/page")                                       │
│    public R<PageVO<UserListVO>> page(@RequestBody PageQuery query)│
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│ 3. Service 处理业务                                            │
│    Page<SysUser> page = userMapper.selectUserPage(             │
│        query.toMpPage(),  // 转换为 MP Page 对象               │
│        query             // 传递查询条件                       │
│    );                                                         │
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│ 4. Mapper 构建查询条件                                         │
│    default Page<SysUser> selectUserPage(Page<SysUser> page,    │
│                                         PageQuery query) {     │
│        // 4.1 确保字段配置已注册                                │
│        ensureConditionsRegistered();                           │
│                                                              │
│        // 4.2 构建 LambdaQueryWrapper                          │
│        LambdaQueryWrapper<SysUser> wrapper = ...;               │
│                                                              │
│        // 4.3 应用快捷搜索（keyword）                           │
│        if (query.getKeyword() != null) {                       │
│            wrapper.and(w -> w.like(SysUser::getUsername, ...)  │
│                .or().like(SysUser::getNickname, ...)          │
│                .or().like(SysUser::getPhoneNumber, ...));      │
│        }                                                       │
│                                                              │
│        // 4.4 应用高级查询（conditions）                        │
│        QueryConditionSupport.applyConditions(                  │
│            wrapper,                                           │
│            query.getConditions(),                              │
│            SysUser.class                                      │
│        );                                                      │
│                                                              │
│        return this.selectPage(page, wrapper);                 │
│    }                                                          │
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│ 5. QueryConditionSupport 应用条件                              │
│    public static <T> void applyConditions(                     │
│        LambdaQueryWrapper<T> wrapper,                          │
│        List<QueryCondition> conditions,                        │
│        Class<T> entityClass) {                                 │
│        // 5.1 获取字段配置                                      │
│        Map<String, FieldConfig<?>> configMap =                 │
│            REGISTRY.get(entityClass);                          │
│                                                              │
│        // 5.2 遍历查询条件                                    │
│        for (QueryCondition condition : conditions) {             │
│            // 5.3 获取字段配置（防止 SQL 注入）                  │
│            FieldConfig<?> config = configMap.get(              │
│                condition.getField()                             │
│            );                                                   │
│            if (config == null) continue; // 忽略未注册字段     │
│                                                              │
│            // 5.4 获取操作符                                    │
│            Operator operator = Operator.fromOperator(           │
│                condition.getOperator()                          │
│            );                                                   │
│                                                              │
│            // 5.5 根据字段类型应用条件                          │
│            switch (config.type()) {                             │
│                case STRING -> applyStringCondition(...);        │
│                case INTEGER -> applyIntCondition(...);          │
│                case LONG -> applyLongCondition(...);            │
│            }                                                   │
│        }                                                       │
│    }                                                          │
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│ 6. MyBatis-Plus 生成 SQL                                       │
│    SELECT * FROM sys_user                                      │
│    WHERE (username LIKE '%admin%'                              │
│           OR nickname LIKE '%admin%'                           │
│           OR phone_number LIKE '%admin%')                      │
│      AND username LIKE '%admin%'                               │
│      AND status = 1                                           │
│      AND is_deleted = 0                                        │
│    ORDER BY create_time DESC                                   │
│    LIMIT 10                                                    │
└────────────────────────────────────────────────────────────────┘
```

### 4.2 字段注册流程

```
┌────────────────────────────────────────────────────────────────┐
│ Mapper 接口定义（以 SysUserMapper 为例）                       │
├────────────────────────────────────────────────────────────────┤
│ default void ensureConditionsRegistered() {                    │
│     QueryConditionSupport.register(SysUser.class,               │
│         FieldConfig.string("username", SysUser::getUsername),   │
│         FieldConfig.string("nickname", SysUser::getNickname),   │
│         FieldConfig.integer("status", SysUser::getStatus)       │
│         // ... 更多字段                                        │
│     );                                                         │
│ }                                                              │
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│ QueryConditionSupport.register()                              │
├────────────────────────────────────────────────────────────────┤
│ 1. 检查是否已注册（幂等操作）                                  │
│    if (REGISTRY.containsKey(entityClass)) return;              │
│                                                              │
│ 2. 创建字段配置 Map                                            │
│    Map<String, FieldConfig<?>> configMap = ...;                │
│                                                              │
│ 3. 遍历配置，存入 Map                                         │
│    for (FieldConfig<T> config : configs) {                     │
│        configMap.put(config.fieldCode(), config);              │
│        // "username" → FieldConfig(string, username)           │
│        // "status" → FieldConfig(integer, status)               │
│    }                                                          │
│                                                              │
│ 4. 存入注册表                                                 │
│    REGISTRY.put(entityClass, configMap);                      │
│    // SysUser.class → {"username": ..., "status": ...}         │
└────────────────────────────────────────────────────────────────┘
```

---

## 五、使用示例

### 5.1 前端请求示例

**场景 1：快捷搜索**
```json
POST /user/page
{
  "pageNum": 1,
  "pageSize": 10,
  "keyword": "admin"
}
```
**生成 SQL**：
```sql
SELECT * FROM sys_user
WHERE (username LIKE '%admin%'
   OR nickname LIKE '%admin%'
   OR phone_number LIKE '%admin%')
   AND is_deleted = 0
ORDER BY create_time DESC
LIMIT 10
```

**场景 2：高级查询**
```json
POST /user/page
{
  "pageNum": 1,
  "pageSize": 10,
  "conditions": [
    {"field": "status", "operator": "EQ", "value": "1"},
    {"field": "deptId", "operator": "EQ", "value": "10"}
  ]
}
```
**生成 SQL**：
```sql
SELECT * FROM sys_user
WHERE status = 1
  AND dept_id = 10
  AND is_deleted = 0
ORDER BY create_time DESC
LIMIT 10
```

**场景 3：组合查询**
```json
POST /user/page
{
  "pageNum": 1,
  "pageSize": 10,
  "keyword": "admin",
  "conditions": [
    {"field": "status", "operator": "EQ", "value": "1"},
    {"field": "deptId", "operator": "IN", "value": "10,20,30"}
  ]
}
```
**生成 SQL**：
```sql
SELECT * FROM sys_user
WHERE (username LIKE '%admin%'
   OR nickname LIKE '%admin%'
   OR phone_number LIKE '%admin%')
  AND status = 1
  AND dept_id IN (10, 20, 30)
  AND is_deleted = 0
ORDER BY create_time DESC
LIMIT 10
```

### 5.2 后端接入示例

**步骤 1：在 Mapper 中定义字段配置**

```java
@Mapper
public interface SysUserMapper extends BaseMapper<SysUser> {

    // 定义可查询字段
    default void ensureConditionsRegistered() {
        QueryConditionSupport.register(SysUser.class,
            FieldConfig.string("username", SysUser::getUsername),
            FieldConfig.string("nickname", SysUser::getNickname),
            FieldConfig.integer("status", SysUser::getStatus)
            // ... 更多字段
        );
    }

    // 分页查询方法
    default Page<SysUser> selectUserPage(Page<SysUser> page, PageQuery query) {
        // 确保字段已注册
        ensureConditionsRegistered();

        LambdaQueryWrapper<SysUser> wrapper = new LambdaQueryWrapper<>();

        // 快捷搜索
        if (StringUtils.hasText(query.getKeyword())) {
            wrapper.and(w -> w.like(SysUser::getUsername, query.getKeyword())
                    .or().like(SysUser::getNickname, query.getKeyword()));
        }

        // 高级查询
        if (query.getConditions() != null) {
            QueryConditionSupport.applyConditions(wrapper, query.getConditions(), SysUser.class);
        }

        return this.selectPage(page, wrapper);
    }
}
```

**步骤 2：Controller 直接使用 PageQuery**

```java
@RestController
@RequestMapping("/user")
public class UserController {

    private final UserService userService;

    @PostMapping("/page")
    public R<PageVO<UserListVO>> page(@RequestBody PageQuery query) {
        return R.success(userService.getUserPage(query));
    }
}
```

**步骤 3：Service 调用 Mapper**

```java
@Service
public class UserService {

    private final SysUserMapper userMapper;

    public PageVO<UserListVO> getUserPage(PageQuery query) {
        Page<SysUser> page = userMapper.selectUserPage(query.toMpPage(), query);
        // ... 转换为 VO
        return PageVO.<UserListVO>builder()
                .pageNum(page.getCurrent())
                .pageSize(page.getSize())
                .total(page.getTotal())
                .records(records)
                .build();
    }
}
```

---

## 六、新模块接入指南

**以角色模块（SysRole）为例，只需 3 步：**

### 步骤 1：在 SysRoleMapper 中注册字段

```java
@Mapper
public interface SysRoleMapper extends BaseMapper<SysRole> {

    default void ensureConditionsRegistered() {
        QueryConditionSupport.register(SysRole.class,
            FieldConfig.string("roleName", SysRole::getRoleName),
            FieldConfig.string("roleKey", SysRole::getRoleKey),
            FieldConfig.integer("status", SysRole::getStatus)
        );
    }
}
```

### 步骤 2：实现分页查询方法

```java
default Page<SysRole> selectRolePage(Page<SysRole> page, PageQuery query) {
    ensureConditionsRegistered();

    LambdaQueryWrapper<SysRole> wrapper = new LambdaQueryWrapper<>();

    // 快捷搜索（角色名/角色键）
    if (StringUtils.hasText(query.getKeyword())) {
        wrapper.and(w -> w.like(SysRole::getRoleName, query.getKeyword())
                .or().like(SysRole::getRoleKey, query.getKeyword()));
    }

    // 高级查询
    if (query.getConditions() != null) {
        QueryConditionSupport.applyConditions(wrapper, query.getConditions(), SysRole.class);
    }

    return this.selectPage(page, wrapper);
}
```

### 步骤 3：Controller 直接使用 PageQuery

```java
@PostMapping("/page")
public R<PageVO<RoleListVO>> page(@RequestBody PageQuery query) {
    return R.success(roleService.getRolePage(query));
}
```

**完成！** 前端可以立即使用动态查询功能。

---

## 七、安全设计

### 7.1 防止 SQL 注入

**问题**：前端直接传入字段名和操作符可能导致 SQL 注入

**解决方案**：字段注册白名单机制

```java
// 只有注册的字段才能查询
Map<String, FieldConfig<?>> configMap = REGISTRY.get(entityClass);

// 如果前端传入的字段未注册，直接忽略
FieldConfig<?> config = configMap.get(condition.getField());
if (config == null) {
    continue; // 忽略未注册字段
}

// 使用 Lambda 表达式，类型安全
wrapper.eq(config.column(), value);  // config.column() 是 SFunction<T, ?>
```

### 7.2 类型安全

```java
// 根据字段类型选择合适的查询方式
switch (config.type()) {
    case STRING -> applyStringCondition(...);    // 字符串：LIKE/NOT_LIKE
    case INTEGER -> applyIntCondition(...);      // 整数：GT/GE/LT/LE
    case LONG -> applyLongCondition(...);        // 长整：GT/GE/LT/LE
}
```

---

## 八、常见问题

### Q1：如何新增一个可查询字段？

**A**：在 Mapper 的 `ensureConditionsRegistered()` 方法中添加一行：

```java
FieldConfig.string("新字段名", SysUser::get新字段名)
```

### Q2：如何支持日期范围查询？

**A**：在 `PageQuery` 中添加专门的字段，如：

```java
private String startTime;  // 开始时间
private String endTime;    // 结束时间
```

然后在 Mapper 中处理：

```java
.ge(startTime != null, SysUser::getCreateTime, startTime)
.le(endTime != null, SysUser::getCreateTime, endTime);
```

### Q3：前端如何构造复杂查询？

**A**：使用 `conditions` 数组，支持 AND 逻辑：

```json
{
  "conditions": [
    {"field": "status", "operator": "EQ", "value": "1"},
    {"field": "deptId", "operator": "IN", "value": "10,20,30"},
    {"field": "createTime", "operator": "GE", "value": "2024-01-01"}
  ]
}
```

---

## 九、总结

### 优势总结

| 对比项 | 传统方式 | 动态查询框架 |
|--------|----------|-------------|
| 代码重复 | 每个模块定义专属 Query DTO | 所有模块共用 PageQuery |
| 维护成本 | 新增字段需修改 DTO、Mapper | 只需注册字段配置 |
| 前端开发 | 每个模块定制表单 | 统一查询组件 |
| 类型安全 | ❌ 字符串拼接 SQL | ✅ Lambda 表达式 |
| SQL 注入风险 | ❌ 存在风险 | ✅ 白名单机制 |

### 适用场景

- ✅ 管理后台列表查询
- ✅ 动态筛选需求
- ✅ 多模块查询逻辑相似
- ✅ 需要灵活组合查询条件

### 不适用场景

- ❌ 复杂的多表联查（建议使用 XML）
- ❌ 需要复杂聚合函数的报表查询
- ❌ 性能要求极高的场景

---

## 十、相关文件清单

| 文件路径 | 说明 |
|---------|------|
| `common/model/PageQuery.java` | 通用分页查询请求 |
| `common/model/PageVO.java` | 通用分页响应 |
| `common/condition/FieldConfig.java` | 字段配置 |
| `common/condition/QueryConditionSupport.java` | 动态查询支持 |
| `common/enums/FieldType.java` | 字段类型枚举 |
| `common/enums/Operator.java` | 操作符枚举 |
| `dto/common/QueryCondition.java` | 查询条件 DTO |
| `modules/system/mapper/SysUserMapper.java` | 用户 Mapper（示例） |
